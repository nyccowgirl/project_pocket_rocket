{% extends 'base.html' %}
{% block content %}

  <h1>User Profile</h1>

  <!-- TO DO: Set each as either menu item on left panel or as scroll down from nav bar. -->

  <h2>{{ user.username }}</h2>

  <h3>About Me</h3>

    <div>
      {% if user.user_pic %}
        <img src='{{ user.user_pic }}'>
      {% else %}
        <img src='/static/img/dragonfly.jpeg'>
      {% endif %}
    </div>

    <div>
      <ul>
        First Name: {{ user.first_name }}<br>
        Last Name: {{ user.last_name }}<br>
        User Name: {{ user.username }}<br>
        Email: {{ user.email }}<br>
        Password: {{ user.password }}<br>
        Birthday: {{ user.dob|datetimeformat('%d %b %Y') }}<br>
        Member Since: {{ user.join_date|datetimeformat('%b %Y') }}<br>
      </ul>
    </div>

  <h3>My Digits</h3>

    <div>
      <ul>
        Check-Ins: {{ session['tot_checkins'] }}<br>
        Reviews: {{ session['tot_revs'] }}<br>
        Referrals: {{ session['tot_refs'] }} | Redeemed: {{ session['redeem_refs'] }}<br>
        Promos Redeemed: {{ session['tot_redeem'] }}<br>
        Friends: {{ session['tot_friends'] }}
      </ul>
    </div>

  {% if user.friends %}
    <h3>My Friends</h3>

    <ul>
    {% for friend in user.friends|sort(attribute='username') %}
      <li>
        <a href='/friend-profile/{{ friend.user_id }}'>{{ friend.username }}</a>
      </li>
    {% endfor %}
    </ul>
  {% endif %}

  {% if user.reviews %}
    <h3>My Reviews</h3>

    <ul>
    {% for review in user.reviews|sort(attribute='review_date') %}
      <li>
        <a href='/business-profile/{{ review.biz.biz_name }}'>{{ review.biz.biz_name}}</a>
        {% if review.revise_review %}
          <p>Rating: {{ review.new_rating }} | Date: {{ review.review_date|datetimeformat('%d %b %Y') }}</p>
          <p>{{ review.new_review }}</p>
        {% else %}
          <p>Rating: {{ review.rating }} | Date: {{ review.review_date|datetimeformat('%d %b %Y') }}</p>
          <p>{{ review.review }}</p>
        {% endif %}
      </li>
    {% endfor %}
    </ul>
  {% endif %}

  {% if user.referees %}
    <h3>My Referrals</h3>

    <ul>
    {% for referrals in user.referees|groupby('biz_id') %}
      {% if loop.first %}
        <li><a href='/business-profile/{{ user.referees.biz.biz_name }}'>{{ user.referees.biz.biz_name }}:</a></li>
      {% endif %}
      <ul>
      {% for referee in referrals.list %}
        </li>{{ referee.username }}: refer date {{ referee.refer_date|datetimeformat('%d %b %Y') }} | redeem date {{ referee.user_promo.redeem_date|datetimeformat('%d %b %Y') }} </li>
      {% endfor %}
      </ul>
    {% endfor %}
    </ul>
  {% endif %}

  {% if user.user_promos %}
    <h3>My Promotions/Redemptions</h3>

    <ul>
    {% for promos in user.user_promos|groupby('promo.biz.biz_name') %}
      <li><a href='/business-profile/{{ promos.grouper }}'>{{ promos.grouper }}:</a>
        <ul>
          {% for promo in promos.list %}
            {% if promo.redeemed %}
              <li>Redeemed: {{ promo.promo.title }}: {{ promo.redeem_date|datetimeformat('%d %b %Y') }}</li>
            {% else %}
              <li>Available: {{ promo.promo.title }} | expiration date: {{ promo.promo.end_date|datetimeformat('%d %b %Y') }}</li>
            {% endif %}
          {% endfor %}
        </ul>
      </li>
    {% endfor %}
    </ul>
  {% endif %}

  {% if user.biz %}
    <h3>My Businesses</h3>

    <ul>
    {% for biz in user.biz %}
      <li><a href='/business-profile{{ biz.biz_name }}'>{{ biz.biz_name }}</a></li>
    {% endfor %}
    </ul>
  {% endif %}

  {% if other_biz %}
    <h3>Businesses to Check Out</h3>

    <ul>
      {% for ref in other_biz %}
        {% for item in ref.user_promo %}
          {% if not item.redeemed %}
            <li><a href='/business-profile{{ ref.biz.biz_name }}'>{{ ref.biz.biz_name }}</li>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </ul>
  {% endif %}

{% endblock %}