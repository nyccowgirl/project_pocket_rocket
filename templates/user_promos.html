{% extends 'base.html' %}

{% block head %}


{% endblock %}

{% block content %}


<div>
  {% if user.user_pic %}
    <img  id='user_pic' src='{{ user.user_pic }}' hspace='40' align='left'>
  {% else %}
    <img  id='user_pic' src='/static/img/dragonfly.jpeg' hspace='40' align='left'>
  {% endif %}
   <h2>{{ user.username }}</h2>
</div>

<hr>

<div class='container-fluid'>

  <button type='button' class='btn btn-unique btn-rounded waves-light' mdbRippleRadius><a href='#'>Redeem a Promo</a></button>

  <!-- TO DO: Need to build out redeem -->

</div>

<hr>

<div class='container-fluid'>

  {% if user.user_promos %}

    <h2>My Promotions/Redemptions</h2>


    {% for grouper, list in user.user_promos|groupby('redeemed')|sort(attribute='promo.end_date') %}
      {% if grouper == False %}
        <p>The following are promotions that are available to be redeemed:</p>
        <input class='form-control' id='myInputAvail' type='text' placeholder='Search..'>
        <br>
        <table class='table table-hover table-responsive table-striped table-bordered' id='myTable'>
        <thead>
          <tr>
            <th>Business Name</th>
            <th>Promo Title</th>
            <th>Promo Description</th>
            <th>Promo End Date</th>
            <th>Redeem</th>
          </tr>
        </thead>

        <tbody>
          {% for promo in list %}
            <tr class='success'>
              <td><a href="/business-profile/{{ promo.biz.biz_name }}">{{ promo.biz.biz_name }}</a></td>
              <td>{{ promo.promo.title }}</td>
              <td>{{ promo.promo.descr }}</td>
              <td>{{ promo.promo.end_date|datetimeformat('%d %b %Y') }}</td>
              <td><button type='button' class='btn-xs btn-unique btn-rounded'><a href='#'>Redeem</a></button></td>
            </tr>
          {% endfor %}
        </tbody>
        </table>

      {% else %}
        <p>The following are promotions have been redeemed:</p>
        <input class='form-control' id='myInputRed' type='text' placeholder='Search..'>
        <br>
        <table class='table table-hover table-responsive table-striped table-bordered'>
        <thead>
          <tr>
            <th>Business Name</th>
            <th>Promo Title</th>
            <th>Promo Description</th>
            <th>Promo Redeem Date</th>
          </tr>
        </thead>

        <tbody>
          {% for promo in list %}
            <tr class='danger'>
              <td><a href="/business-profile/{{ promo.biz.biz_name }}">{{ promo.biz.biz_name }}</a></td>
              <td>{{ promo.promo.title }}</td>
              <td>{{ promo.promo.descr }}</td>
              <td>{{ promo.redeem_date|datetimeformat('%d %b %Y') }}</td>
            </tr>
          {% endfor %}
        </tbody>
        </table>
      {% endif %}
    {% endfor %}

<!--     <ul>
    {% for grouper, list in user.user_promos|groupby('redeemed') %}
      {% if grouper == False %}
        <b>Available</b>
          <ul>
            {% for grouper, list in list|groupby('promo.biz.biz_name') %}
              <a href='/business-profile/{{ grouper }}'>{{ grouper }}:</a>|
                {% if promo.biz.deg_of_sep(session['user_id']) %}
                  <i class='fa fa-chain prefix'></i>{{ promo.biz.deg_of_sep(session['user_id']) }}
                {% else %}
                  <i class='fa fa-chain-broken prefix'></i>
                {% endif %}
                {% for promo in list %}
                  <li>{{ promo.promo.title }}: {{ promo.promo.descr }} | expiration date: {{ promo.promo.end_date|datetimeformat('%d %b %Y') }}</li>
                {% endfor %}
            {% endfor %}
          </ul>
      {% else %}
        <br>
        <b>Redeemed</b>
          <ul>
            {% for grouper, list in list|groupby('promo.biz.biz_name') %}
              <a href='/business-profile/{{ grouper }}'>{{ grouper }}:</a>|
                {% if promo.biz.deg_of_sep(session['user_id']) %}
                  <i class='fa fa-chain prefix'></i>{{ promo.biz.deg_of_sep(session['user_id']) }}
                {% else %}
                  <i class='fa fa-chain-broken prefix'></i>
                {% endif %}
                {% for promo in list %}
                  <li>{{ promo.promo.title }}: {{ promo.redeem_date|datetimeformat('%d %b %Y') }}</li>
                {% endfor %}
            {% endfor %}
          </ul>
      {% endif %}
    {% endfor %}
    </ul> -->
  {% else %}

  <p>Many small businesses have promotions for new and repeat customers and/or referrals. Please check out a local business near you and redeem one of their promotions or refer friends to unlock special promotions.

  <button type='button' class='btn-sm btn-unique btn-rounded waves-light' mdbRippleRadius><a href='#'>Refer a business.</a></button>

  <!-- TO DO: Build out user referrals -->

  {% endif %}

</div>

{% endblock %}

{% block script %}



{% endblock %}